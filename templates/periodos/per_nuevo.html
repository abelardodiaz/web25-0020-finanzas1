<!-- templates/periodos/per_nuevo.html -->
{% extends "base.html" %}
{% block title %}Nuevo periodo{% endblock %}
{% block content %}
<h1>
  {% if cuenta %}
    Nuevo periodo – {{ cuenta }}
  {% else %}
    Nuevo periodo
  {% endif %}
</h1>

<form method="post">
  {% csrf_token %}
  
  {{ form.grupo.as_hidden }}  <!-- Hidden group field -->
  
{% if cuenta %}
    {{ form.cuenta.as_hidden }}
{% else %}
    <div class="mb-3">
        <label class="form-label">Cuenta</label>
        <!-- Custom select with group data attributes -->
        <select name="cuenta" class="form-select" id="id_cuenta" required>
            {% for c in cuentas %}
                <option value="{{ c.pk }}" data-grupo="{{ c.tipo.grupo }}">
                    {{ c.nombre }} ({{ c.tipo.nombre }})
                </option>
            {% endfor %}
        </select>
    </div>
{% endif %}
  
  <!-- Common fields -->
  <div class="mb-3">
    <label class="form-label">Fecha de corte</label>
    {{ form.fecha_corte }}
  </div>


  <!-- Group-specific fields -->
  <div id="cre-fields" class="card mb-3" {% if form.grupo.value != 'CRE' %}style="display:none"{% endif %}>
    <div class="card-header">Detalles de crédito</div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Pago mínimo</label>
        {{ form.pago_minimo }}
      </div>
      <div class="mb-3">
        <label class="form-label">Pago sin intereses</label>
        {{ form.pago_no_intereses }}
      </div>
      <div id="fecha-limite-wrap" class="mb-3">        
        <label class="form-label">Fecha límite de pago</label>
        {{ form.fecha_limite_pago }}
      </div>
    </div>
  </div>

  <div id="ser-fields" class="card mb-3" {% if form.grupo.value != 'SER' %}style="display:none"{% endif %}>
    <div class="card-header">Detalles de servicio</div>
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label">Monto pronto pago</label>
        {{ form.monto_pronto_pago }}
      </div>
      <div class="mb-3">
        <label class="form-label">Fecha pronto pago</label>
        {{ form.fecha_pronto_pago }}
      </div>
      <div class="mb-3">
        <label class="form-label">Monto total del periodo</label>
        {{ form.monto_total }}
      </div>
      <div id="fecha-limite-wrap" class="mb-3">        
        <label class="form-label">Fecha límite de pago</label>
        {{ form.fecha_limite_pago }}
      </div>      
    </div>
  </div>

  <div id="deb-fields" class="card mb-3" 
       {% if form.grupo.value != 'DEB' and form.grupo.value != 'EFE' %}style="display:none"{% endif %}>
    <div class="card-body">
      <p class="text-muted">
        Las cuentas de débito y efectivo no requieren información adicional.
      </p>
    </div>
  </div>

  <div class="mt-4">
    <button type="submit" class="btn btn-primary">Guardar</button>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', function () {
  const cuentaField = document.querySelector('[name="cuenta"]');
  const grupoField  = document.querySelector('[name="grupo"]');

  function updateFields() {
    const g = grupoField.value;
    document.getElementById('cre-fields').style.display = g === 'CRE' ? 'block' : 'none';
    document.getElementById('ser-fields').style.display = g === 'SER' ? 'block' : 'none';
    document.getElementById('deb-fields').style.display = (g === 'DEB' || g === 'EFE') ? 'block' : 'none';
  }

  /* ---------- NUEVO: fijar grupo inicial ---------- */
  if (!grupoField.value && cuentaField) {                // si grupo viene vacío
    const opt = cuentaField.options[cuentaField.selectedIndex];
    if (opt) grupoField.value = opt.getAttribute('data-grupo');  // DEB / SER / CRE / EFE
  }
  /* ------------------------------------------------ */

  // Cambiar grupo cuando el usuario elija otra cuenta
  if (cuentaField) {
    cuentaField.addEventListener('change', function () {
      const opt = this.options[this.selectedIndex];
      grupoField.value = opt.getAttribute('data-grupo');
      updateFields();
    });
  }

  // Mostrar campos correctos en el primer render
  updateFields();
});
</script>
</form>
{% endblock %}