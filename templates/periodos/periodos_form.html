<!-- templates/periodos/per_nuevo.html -->
{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}Nuevo periodo{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">
        {% if cuenta %}
            Nuevo periodo – {{ cuenta }}
        {% else %}
            {% if object %}Editar{% else %}Nuevo{% endif %} Periodo
        {% endif %}
    </h1>
    
    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg shadow p-6">
        <form method="post">
            {% csrf_token %}
            {% if form.errors %}
            <div class="mb-6 bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 text-red-800 dark:text-red-200 p-4 rounded-md">
                <strong class="font-semibold">Corrige los siguientes errores:</strong>
                <ul class="mt-2 list-disc list-inside">
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        
            {{ form.grupo.as_hidden }}  <!-- Hidden group field -->
            
        {% if cuenta %}
            {{ form.cuenta.as_hidden }}
        {% else %}
            <div class="mb-4">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Cuenta</label>
                <!-- Custom select with group data attributes -->
                <select name="cuenta" class="w-full px-3 py-2 text-lg border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-gray-200" id="id_cuenta" required>
                    {% for c in cuentas %}
                        <option value="{{ c.pk }}" data-grupo="{{ c.tipo.grupo }}" data-diacorte="{{ c.dia_corte }}"
                            {% if form.instance.cuenta_id == c.pk %}selected{% endif %}>
                            {{ c.nombre }} ({{ c.tipo.nombre }})
                        </option>
                    {% endfor %}
                </select>
            </div>
        {% endif %}
        
            <!-- Saldo inicial manual opcional -->
            <div class="mb-4">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Saldo inicial manual</label>
                {{ form.saldo_inicial_manual|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Déjalo vacío para que el sistema lo calcule automáticamente.</p>
            </div>
        
            <!-- Usar saldo previo -->
            <div class="mb-4">
                <div class="flex items-center">
                    {{ form.usar_saldo_prev|add_class:"h-5 w-5 text-blue-600 rounded" }}
                    <label class="ml-2 text-lg font-medium text-gray-700 dark:text-gray-300" for="id_usar_saldo_prev">Usar saldo del periodo anterior</label>
                </div>
            </div>
        
            <!-- Common fields -->
            <div class="mb-4">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Fecha de corte</label>
                {{ form.fecha_corte|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                {% if form.fecha_corte.errors %}
                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                        {% for error in form.fecha_corte.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        
            <div class="mb-4">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Fin del periodo</label>
                {{ form.fecha_fin_periodo|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                {% if form.fecha_fin_periodo.errors %}
                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                        {% for error in form.fecha_fin_periodo.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        
            <!-- Fecha límite de pago (única) -->
            <div class="mb-4">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Fecha límite de pago</label>
                {{ form.fecha_limite_pago|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                {% if form.fecha_limite_pago.errors %}
                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                        {% for error in form.fecha_limite_pago.errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        
            <!-- Group-specific fields -->
            <div id="cre-fields" class="bg-white dark:bg-gray-700 rounded-lg shadow mb-4" {% if form.grupo.value != 'CRE' %}style="display:none"{% endif %}>
                <div class="bg-gray-100 dark:bg-gray-600 px-4 py-3 rounded-t-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Detalles de crédito</h3>
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Pago mínimo</label>
                        {{ form.pago_minimo|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    </div>
                    <div class="mb-4">
                        <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Pago sin intereses</label>
                        {{ form.pago_no_intereses|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    </div>
                </div>
            </div>
        
            <div id="ser-fields" class="bg-white dark:bg-gray-700 rounded-lg shadow mb-4" {% if form.grupo.value != 'SER' %}style="display:none"{% endif %}>
                <div class="bg-gray-100 dark:bg-gray-600 px-4 py-3 rounded-t-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Detalles de servicio</h3>
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Monto pronto pago</label>
                        {{ form.monto_pronto_pago|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    </div>
                    <div class="mb-4">
                        <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Fecha pronto pago</label>
                        {{ form.fecha_pronto_pago|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    </div>
                    <div class="mb-4">
                        <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Monto total del periodo</label>
                        {{ form.monto_total|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    </div>
                </div>
            </div>
        
            <div id="deb-fields" class="bg-white dark:bg-gray-700 rounded-lg shadow mb-4" 
                 {% if form.grupo.value != 'DEB' and form.grupo.value != 'EFE' %}style="display:none"{% endif %}>
                <div class="p-4">
                    <p class="text-gray-600 dark:text-gray-400">
                        Las cuentas de débito y efectivo no requieren información adicional.
                    </p>
                </div>
            </div>
        
            <div class="mt-6 flex space-x-3">
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md flex items-center text-lg">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <a href="{% if cuenta %}{% url 'core:cuenta_detail' cuenta.pk %}{% else %}{% url 'core:periodos_list' %}{% endif %}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md flex items-center text-lg">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </a>
            </div>
        </form>
    </div>

  <script>
document.addEventListener('DOMContentLoaded', function () {
  const cuentaField = document.querySelector('[name="cuenta"]');
  const grupoField  = document.querySelector('[name="grupo"]');
  const fechaCorteInput = document.querySelector('#id_fecha_corte');
  const fechaFinInput   = document.querySelector('#id_fecha_fin_periodo');

  function updateFields() {
    const g = grupoField.value;
    document.getElementById('cre-fields').style.display = g === 'CRE' ? 'block' : 'none';
    document.getElementById('ser-fields').style.display = g === 'SER' ? 'block' : 'none';
    document.getElementById('deb-fields').style.display = (g === 'DEB' || g === 'EFE') ? 'block' : 'none';
  }

  function calcNextCutoff(baseDay) {
    const today = new Date();
    // Crea fecha tentativa para este mes
    let tentative = new Date(today.getFullYear(), today.getMonth(), Math.min(baseDay,28));
    if (today >= tentative) {
      // usar siguiente mes
      tentative.setMonth(tentative.getMonth()+1);
    }
    tentative.setDate(baseDay);
    return tentative.toISOString().slice(0,10); // yyyy-mm-dd
  }

  /* ---------- NUEVO: fijar grupo inicial ---------- */
  if (!grupoField.value && cuentaField) {                // si grupo viene vacío
    const opt = cuentaField.options[cuentaField.selectedIndex];
    if (opt) grupoField.value = opt.getAttribute('data-grupo');  // DEB / SER / CRE / EFE
  }
  /* ------------------------------------------------ */

  // Cambiar grupo cuando el usuario elija otra cuenta
  if (cuentaField) {
    cuentaField.addEventListener('change', function () {
      const opt = this.options[this.selectedIndex];
      grupoField.value = opt.getAttribute('data-grupo');
      updateFields();

      const diacorte = opt.getAttribute('data-diacorte');
      if (diacorte) {
         const fc = calcNextCutoff(parseInt(diacorte));
         fechaCorteInput.value = fc;
         // fin de periodo = misma fecha corte por ahora
         fechaFinInput.value  = fc;
      }
    });
  }

  // Mostrar campos correctos en el primer render
  updateFields();

  function toggleRequiredFields() {
    const grupo = grupoField.value;
    
    // Servicios
    const serFields = ['monto_total', 'pago_no_intereses'];
    serFields.forEach(field => {
      const el = document.querySelector(`[name="${field}"]`);
      if (el) el.required = (grupo === 'SER');
    });

    // Créditos
    const creFields = ['pago_minimo', 'pago_no_intereses'];
    creFields.forEach(field => {
      const el = document.querySelector(`[name="${field}"]`);
      if (el) el.required = (grupo === 'CRE');
    });
  }

  // Actualizar al cambiar grupo
  if (cuentaField) {
    cuentaField.addEventListener('change', function() {
      updateFields();
      toggleRequiredFields();
    });
  }
  
  // Inicializar
  toggleRequiredFields();
});
</script>
  {% if debug_info %}
  <div class="mt-6 bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg shadow">
    <div class="bg-red-100 dark:bg-red-800 px-4 py-3 rounded-t-lg">
      <h5 class="text-lg font-semibold text-red-800 dark:text-red-200">Panel de Diagnóstico</h5>
    </div>
    <div class="p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <h6 class="font-semibold text-red-700 dark:text-red-300 mb-2">Datos Enviados (POST):</h6>
          <pre class="text-sm bg-red-100 dark:bg-red-800 p-2 rounded overflow-x-auto">{{ debug_info.post_data|pprint }}</pre>
        </div>
        <div>
          <h6 class="font-semibold text-red-700 dark:text-red-300 mb-2">Datos Limpiados:</h6>
          <pre class="text-sm bg-red-100 dark:bg-red-800 p-2 rounded overflow-x-auto">{{ debug_info.cleaned_data|pprint }}</pre>
        </div>
        <div>
          <h6 class="font-semibold text-red-700 dark:text-red-300 mb-2">Errores:</h6>
          <pre class="text-sm bg-red-100 dark:bg-red-800 p-2 rounded overflow-x-auto">{{ debug_info.errors|pprint }}</pre>
        </div>
      </div>
      
      <h6 class="mt-4 font-semibold text-red-700 dark:text-red-300">Solución sugerida:</h6>
      <ol class="list-decimal list-inside text-red-700 dark:text-red-300 space-y-1">
        <li>Verifica que el formato de fecha sea YYYY-MM-DD</li>
        <li>Revisa que el campo no esté siendo modificado por JavaScript</li>
        <li>Prueba con diferentes navegadores (Chrome, Firefox)</li>
      </ol>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}