{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}{% if object %}Editar{% else %}Nueva{% endif %} Transacción{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200 mb-6">
        {% if object %}Editar{% else %}Nueva{% endif %} Transacción
    </h1>
    
    <div class="bg-gray-50 dark:bg-gray-800 rounded-lg shadow p-6">
        <form method="post" novalidate id="transaccion-form">
            {% csrf_token %}
            
            <!-- Campos básicos -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Monto -->
                <div>
                    <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {{ form.monto.label }}
                    </label>
                    {{ form.monto|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    {% if form.monto.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.monto.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Fecha -->
                <div>
                    <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {{ form.fecha.label }}
                    </label>
                    {{ form.fecha|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    {% if form.fecha.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.fecha.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Descripción -->
            <div class="mb-6">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ form.descripcion.label }}
                </label>
                {{ form.descripcion|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                {% if form.descripcion.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.descripcion.errors.0 }}</p>
                {% endif %}
            </div>
            
            <!-- Cuenta Origen -->
            <div class="mb-6">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ form.cuenta_origen.label }}
                </label>
                {{ form.cuenta_origen|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                {% if form.cuenta_origen.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.cuenta_origen.errors.0 }}</p>
                {% endif %}
            </div>
            
            <!-- Tipo de destino (Radio buttons) -->
            <div class="mb-6">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ form.destino_tipo.label }}
                </label>
                <div class="space-y-2">
                    {% for radio in form.destino_tipo %}
                        <label class="flex items-center">
                            {{ radio.tag }}
                            <span class="ml-2 text-lg text-gray-700 dark:text-gray-300">{{ radio.choice_label }}</span>
                        </label>
                    {% endfor %}
                </div>
                {% if form.destino_tipo.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ form.destino_tipo.errors.0 }}</p>
                {% endif %}
            </div>
            
            <!-- Campos condicionales -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Cuenta Destino (para transferencias) -->
                <div id="cuenta_destino_div">
                    <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {{ form.cuenta_destino.label }}
                    </label>
                    {{ form.cuenta_destino|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    {% if form.cuenta_destino.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.cuenta_destino.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Categoría (para gastos/ingresos) -->
                <div id="categoria_div">
                    <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">
                        {{ form.categoria.label }}
                    </label>
                    {{ form.categoria|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                    {% if form.categoria.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.categoria.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Período (opcional) -->
            <div class="mb-6">
                <label class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">
                    {{ form.periodo.label }}
                    <span class="text-sm text-gray-500">(opcional)</span>
                </label>
                {{ form.periodo|add_class:"text-lg py-2 px-3 w-full rounded border border-gray-300 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" }}
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ form.periodo.help_text }}</p>
            </div>
            
            <!-- Checkboxes -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Ajuste -->
                <div class="flex items-start space-x-2">
                    {{ form.ajuste|add_class:"mt-1" }}
                    <div>
                        <label for="id_ajuste" class="text-lg font-medium text-gray-700 dark:text-gray-300">
                            {{ form.ajuste.label }}
                        </label>
                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ form.ajuste.help_text }}</p>
                    </div>
                </div>
                
                <!-- Conciliado -->
                <div class="flex items-start space-x-2">
                    {{ form.conciliado|add_class:"mt-1" }}
                    <div>
                        <label for="id_conciliado" class="text-lg font-medium text-gray-700 dark:text-gray-300">
                            {{ form.conciliado.label }}
                        </label>
                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ form.conciliado.help_text }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Botones -->
            <div class="flex space-x-4 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md flex items-center text-lg">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
                <a href="{% url 'core:transacciones_list' %}" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-md flex items-center text-lg">
                    <i class="fas fa-times mr-2"></i>Cancelar
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener elementos
    const destinoTipoRadios = document.querySelectorAll('input[name="destino_tipo"]');
    const cuentaDestinoDiv = document.getElementById('cuenta_destino_div');
    const categoriaDiv = document.getElementById('categoria_div');
    
    // Función para mostrar/ocultar campos según el tipo de destino
    function toggleFields() {
        const selectedValue = document.querySelector('input[name="destino_tipo"]:checked')?.value;
        
        if (selectedValue === 'cuenta') {
            // Mostrar cuenta destino, ocultar categoría
            cuentaDestinoDiv.style.display = 'block';
            categoriaDiv.style.display = 'none';
            // Limpiar categoría
            document.getElementById('id_categoria').value = '';
        } else if (selectedValue === 'categoria') {
            // Mostrar categoría, ocultar cuenta destino
            cuentaDestinoDiv.style.display = 'none';
            categoriaDiv.style.display = 'block';
            // Limpiar cuenta destino
            document.getElementById('id_cuenta_destino').value = '';
        }
    }
    
    // Agregar listeners a los radio buttons
    destinoTipoRadios.forEach(radio => {
        radio.addEventListener('change', toggleFields);
    });
    
    // Ejecutar al cargar la página
    toggleFields();
    
    // Validación del formulario
    const form = document.getElementById('transaccion-form');
    form.addEventListener('submit', function(e) {
        const monto = document.getElementById('id_monto').value;
        const fecha = document.getElementById('id_fecha').value;
        const descripcion = document.getElementById('id_descripcion').value;
        const cuentaOrigen = document.getElementById('id_cuenta_origen').value;
        
        if (!monto || !fecha || !descripcion || !cuentaOrigen) {
            e.preventDefault();
            alert('Por favor complete todos los campos obligatorios');
            return false;
        }
        
        // Verificar que se haya seleccionado destino
        const selectedValue = document.querySelector('input[name="destino_tipo"]:checked')?.value;
        if (selectedValue === 'cuenta') {
            const cuentaDestino = document.getElementById('id_cuenta_destino').value;
            if (!cuentaDestino) {
                e.preventDefault();
                alert('Por favor seleccione la cuenta destino');
                return false;
            }
        } else if (selectedValue === 'categoria') {
            const categoria = document.getElementById('id_categoria').value;
            if (!categoria) {
                e.preventDefault();
                alert('Por favor seleccione una categoría');
                return false;
            }
        }
    });
});
</script>
{% endblock %}