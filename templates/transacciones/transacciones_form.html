<!-- file: templates/trasacciones/tr_nueva.html -->
{% extends "base.html" %}
{% block title %}Nuevo Movimiento{% endblock %}
{% block content %}
<h1>Nuevo Movimiento</h1>
<form method="post" novalidate id="transaccion-form">
  {% csrf_token %}
  <p>
    {{ form.monto.label_tag }} {{ form.monto }}
  </p>
  <p>
    {{ form.tipo.label_tag }} {{ form.tipo }}
  </p>
  <p>
    {{ form.fecha.label_tag }} {{ form.fecha }}
  </p>
  <p>
    {{ form.descripcion.label_tag }} {{ form.descripcion }}
  </p>
  <p id="row-servicio">
    <label id="lbl-servicio">{{ form.cuenta_servicio.label }}</label>
    {{ form.cuenta_servicio }}
    <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-cuentas" title="Actualizar cuentas de servicio">↻</button>
  </p>
  <p>
    {{ form.categoria.label_tag }} {{ form.categoria }}
    <button type="button" class="btn btn-outline-secondary btn-sm" id="refresh-categorias" title="Actualizar categorías">↻</button>
  </p>
  <div class="form-group" id="row-mediopago">
    <label id="lbl-mediopago" for="id_medio_pago">{{ form.medio_pago.label }}</label>
    <div class="d-flex">
      {{ form.medio_pago }}
      <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="refresh-medios" title="Actualizar medios de pago">
        <i class="bi bi-arrow-repeat"></i>
      </button>
    </div>
  </div>

  <p>
    {{ form.ajuste }} {{ form.ajuste.label_tag }}
    <small class="text-muted">Marcar solo si deseas registrar un único movimiento (ajuste manual).</small>
  </p>
  <button class="btn btn-primary">Guardar</button>
  <a href="{% url 'core:transacciones_list' %}" class="btn btn-secondary">Cancelar</a>
</form>

<!-- Aviso / previsualización de partida doble -->
<div id="preview-doble" class="alert alert-info d-none">
  <strong>Se crearán dos movimientos:</strong>
  <ul class="mb-0">
    <li id="prev-cargo"></li>
    <li id="prev-abono"></li>
  </ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  function actualizarCampo(url, selectId) {
    fetch(url)
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById(selectId);
        if (!select) return;
        const valorActual = select.value;
        select.innerHTML = '';
        const optVacio = document.createElement('option');
        optVacio.value = '';
        optVacio.textContent = '---------';
        select.appendChild(optVacio);
        data.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.text;
          opt.dataset.naturaleza = item.naturaleza;  // Guardar la naturaleza
          select.appendChild(opt);
        });
        // intenta mantener la selección previa si sigue existiendo
        select.value = valorActual;
      });
  }
  document.getElementById('refresh-cuentas').addEventListener('click', function() {
    actualizarCampo('{% url "core:refresh_cuentas" %}', 'id_cuenta_servicio');
  });
  document.getElementById('refresh-categorias').addEventListener('click', function() {
    actualizarCampo('{% url "core:refresh_categorias" %}', 'id_categoria');
  });

  // Añadir manejador para medios de pago
  document.getElementById('refresh-medios').addEventListener('click', function() {
    actualizarCampo('{% url "core:refresh_medios_pago" %}', 'id_medio_pago');
  });

  // ==== Vista previa de doble movimiento ====
  const selServicio = document.getElementById('id_cuenta_servicio');
  const selPago     = document.getElementById('id_medio_pago');
  const inpMonto    = document.getElementById('id_monto');
  const chkAjuste   = document.getElementById('id_ajuste');
  const boxPrev     = document.getElementById('preview-doble');
  const liCargo     = document.getElementById('prev-cargo');
  const liAbono     = document.getElementById('prev-abono');

  function actualizarPreview() {
    const servOpt = selServicio.options[selServicio.selectedIndex];
    const pagoOpt = selPago.options[selPago.selectedIndex];
    
    // Usar valor absoluto para el monto
    const monto = Math.abs(parseFloat(inpMonto.value)) || 0;
    
    const camposValidos = servOpt && pagoOpt && monto > 0 && 
                          selServicio.value !== selPago.value;
    
    if (chkAjuste.checked || !camposValidos) {
      boxPrev.classList.add('d-none');
      return;
    }

    // Determinar etiquetas según el tipo de operación
    const tipoOp = selTipo.value;
    let txtPago, txtServ;

    if (tipoOp === 'GASTO') {
      // Dinero sale de la cuenta de pago → Abono / entra al servicio → Cargo
      txtPago = 'Abono';
      txtServ = 'Cargo';
    } else if (tipoOp === 'INGRESO') {
      // Dinero entra a la cuenta de pago → Cargo / sale del servicio (o cuenta contraparte) → Abono
      txtPago = 'Cargo';
      txtServ = 'Abono';
    } else if (tipoOp === 'TRANSFERENCIA') {
      // Etiquetas dependen de la naturaleza de cada cuenta
      const natPago = pagoOpt.dataset.naturaleza;
      const natServ = servOpt.dataset.naturaleza;

      // Origen
      txtPago = (natPago === 'DEUDORA') ? 'Abono' : 'Cargo';
      // Destino
      txtServ = (natServ === 'DEUDORA') ? 'Cargo' : 'Abono';
    } else {
      // Fallback genérico
      txtPago = 'Cargo';
      txtServ = 'Abono';
    }
 
    // Asignación correcta:
    liCargo.textContent = `${txtPago} en ${pagoOpt.text}: $${monto.toFixed(2)}`;
    liAbono.textContent = `${txtServ} en ${servOpt.text}: $${monto.toFixed(2)}`;
    
    boxPrev.classList.remove('d-none');
  }

  [selServicio, selPago, inpMonto, chkAjuste].forEach(el => {
    if (el) el.addEventListener('change', actualizarPreview);
    if (el) el.addEventListener('input', actualizarPreview);
  });

  // inicializar al cargar
  actualizarPreview();

  // === Toggle campos según tipo ====
  const selTipo = document.getElementById('id_tipo');
  const rowServ = document.getElementById('row-servicio');
  const rowPago = document.getElementById('row-mediopago');
  const lblServ = document.getElementById('lbl-servicio');
  const lblPago = document.getElementById('lbl-mediopago');

  function toggleTipo() {
    const v = selTipo.value;
    if (v === 'TRANSFERENCIA') {
      rowServ.hidden = false;
      rowPago.hidden = false;
      lblServ.textContent = 'Cuenta destino';
      lblPago.textContent = 'Cuenta origen';
      actualizarCampo('{% url "core:refresh_medios_pago" %}', 'id_cuenta_servicio');
    } else if (v === 'AJUSTE') {
      rowServ.hidden = true;
      rowPago.hidden = false;
      lblPago.textContent = 'Cuenta';
      // Para ajustes mostramos igualmente medios de pago por consistencia
      actualizarCampo('{% url "core:refresh_medios_pago" %}', 'id_cuenta_servicio');
    } else {
      // GASTO o INGRESO
      rowServ.hidden = false;
      rowPago.hidden = false;
      lblServ.textContent = 'Servicio / Proveedor';
      lblPago.textContent = 'Cuenta de pago';
      actualizarCampo('{% url "core:refresh_cuentas" %}', 'id_cuenta_servicio');
    }
  }

  if (selTipo) {
    selTipo.addEventListener('change', () => { toggleTipo(); actualizarPreview(); });
    toggleTipo();
  }

  // Recargar naturalezas al abrir el formulario
  actualizarCampo('{% url "core:refresh_cuentas" %}', 'id_cuenta_servicio');
  actualizarCampo('{% url "core:refresh_medios_pago" %}', 'id_medio_pago');
});
</script>
{% endblock %}
